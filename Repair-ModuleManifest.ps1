#!/usr/local/bin/pwsh
#Requires -version 3
# Update Module Manifest
# move/rename source psd1 file
# pass original properties from source manifest/data to New-ModuleManifest

function Repair-ModuleManifest {
  <#
      .SYNOPSIS
      Replaces module manifest (psd1) file with one generated by New-ModuleManifest
      .DESCRIPTION
      Preserves original properties from source manifest / data file, and passes the properties as variables to New-ModuleManifest
      .EXAMPLE
      Repair-ModuleManifest -Path .\Module\Patchy\Patchy.psd1
      .Link
      Edit-Module
  #>
  [CmdletBinding()]
    param(
        [Parameter(Position = 0)]
        [ValidateScript({Test-Path -Path $PSItem})]
        [string]
        $Path
    )
    
	$SupportedProperties = @('AliasesToExport', 'Author', 'ClrVersion', 'CmdletsToExport', 'CompanyName', 'DefaultCommandPrefix', 'Description', 'DotNetFrameworkVersion', 'FileList', 'FormatsToProcess', 'FunctionsToExport', 'Guid', 'HelpInfoUri', 'ModuleList', 'ModuleVersion', 'NestedModules', 'PowerShellHostVersion', 'PowerShellVersion', 'PrivateData', 'ProcessorArchitecture', 'RequiredAssemblies', 'RequiredModules', 'RootModule', 'ScriptsToProcess', 'TypesToProcess', 'VariablesToExport')

  try {
    $manifest = Test-ModuleManifest -Path $Path
  }
  catch {
    throw ('Failed to read properties from PowerShell Data file {0}' -f $Path)
  }

  # Before working with any manifest properties, which include relative paths, move current location to the root of the manifest / module
  Push-Location -Path (Split-Path -Path $Path -Parent) #-PassThru

    foreach ($property in $SupportedProperties) {
        Write-Verbose -Message ('Inspecting property {0}' -f $property)
        $ErrorActionPreference = 'Ignore'
        if ([bool]($manifest.$property)) {
            Write-Verbose -Message ('This property was {0}' -f $manifest.$property)
            if ($property -like '*List') {
                $NewPropString += (' -{0} @(' -f $property) + $(($manifest.$property | Resolve-Path -Relative) -join ',') + ')'
            } elseif ($($manifest.$property).Contains(' ')) {
                Write-Debug -Message 'Wrapping $property value with quote-marks'
                $NewPropString += (" -{0} '{1}'" -f $property, $manifest.$property)
            } else {
                $NewPropString += (' -{0} {1}' -f $property, $manifest.$property)
            }
        } else {
            Write-Verbose -Message ('Skipping unmatched / undefined {0}' -f $property)
        }
    }

  Write-Debug -Message ('$NewPropString : {0}' -f $NewPropString)
  $ErrorActionPreference = 'Stop'

  if ($NewPropString -notlike '*-RootModule*') {
    Write-Verbose -Message ('Defining RootModule property; {0}' -f $RootModule)
    Write-Debug -Message ('Defining RootModule property; {0}' -f $RootModule)
    $RootModule = (Split-Path -Path $Path -Leaf) -replace '.psd1', '.psm1'
    $NewPropString += (" -RootModule '{0}'" -f $RootModule)
  }

  if ($NewPropString -notlike '*-ModuleVersion*') {
    Write-Verbose -Message 'Defining new ModuleVersion'
    $NewPropString += ' -ModuleVersion 1.0.1'
  } else {
    Write-Verbose -Message 'Incrementing ModuleVersion'
    Write-Debug -Message (' -ModuleVersion {0}.{1}.{2}'-f [int]($manifest.Version.Major), [int]($manifest.Version.Minor), [int]($manifest.Version.Build+1))
    $NewPropString += ' -ModuleVersion {0}.{1}.{2}' -f [int]($manifest.Version.Major), [int]($manifest.Version.Minor), [int]($manifest.Version.Build+1)
  }
    
  Write-Debug   -Message $NewPropString

  Update-ModuleManifest -Path $Path $NewPropString
    
  Pop-Location
  <#
      New-ModuleManifest [-Path] <String>
      -AliasesToExport <String[]>
      -Author <String>
      -ClrVersion <Version>]
      -CmdletsToExport <String[]>
      -CompanyName <String>
      -Copyright <String>
      -DefaultCommandPrefix <String>
      -Description <String>
      -DotNetFrameworkVersion <Version>
      -FileList <String[]>
      -FormatsToProcess <String[]>
      -FunctionsToExport <String[]>
      -Guid <Guid>
      -HelpInfoUri <String>
      -ModuleList <Object[]>
      -ModuleVersion <Version>
      -NestedModules <Object[]>
      -PowerShellHostName <String>
      -PowerShellHostVersion <Version>
      -PowerShellVersion <Version>
      -PrivateData <Object>
      -ProcessorArchitecture <ProcessorArchitecture>
      -RequiredAssemblies <String[]>
      -RequiredModules <Object[]>
      -RootModule <String>
      -ScriptsToProcess <String[]>
      -TypesToProcess <String[]>
      -VariablesToExport <String[]>
  #>
}
